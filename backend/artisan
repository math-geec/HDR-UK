#!/usr/bin/env php
<?php

use Illuminate\Foundation\Application;
use Symfony\Component\Console\Input\ArgvInput;

define('LARAVEL_START', microtime(true));

// Suppress PHP 8.5 deprecation notices for PDO constants during CLI runs.
error_reporting(E_ALL & ~E_DEPRECATED & ~E_USER_DEPRECATED);

// Register the Composer autoloader...
require __DIR__.'/vendor/autoload.php';

// Basic global exception/shutdown handlers for CLI to capture uncaught errors during artisan runs
set_exception_handler(function (Throwable $e) {
	$logPath = __DIR__.'/storage/logs/laravel.log';
	$message = sprintf("[%s] Uncaught Exception (artisan): %s in %s:%s\nStack trace:\n%s\n\n", date('Y-m-d H:i:s'), $e->getMessage(), $e->getFile(), $e->getLine(), $e->getTraceAsString());
	@file_put_contents($logPath, $message, FILE_APPEND);
});

register_shutdown_function(function () {
	$err = error_get_last();
	if ($err !== null) {
		$logPath = __DIR__.'/storage/logs/laravel.log';
		$message = sprintf("[%s] Shutdown Error (artisan): %s in %s:%s\n\n", date('Y-m-d H:i:s'), $err['message'], $err['file'] ?? '', $err['line'] ?? '');
		@file_put_contents($logPath, $message, FILE_APPEND);
	}
});

// Bootstrap Laravel and handle the command...
/** @var Application $app */
$app = require_once __DIR__.'/bootstrap/app.php';

$status = $app->handleCommand(new ArgvInput);

exit($status);
